<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Finder v2</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      flex-wrap: wrap;
      gap: 10px;
    }

    .header h1 { font-size: 1.4rem; }

    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Focus Banner */
    .focus-banner {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 10px 25px;
      display: none;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .focus-banner.active { display: flex; }

    .focus-banner .focus-tags { display: flex; gap: 8px; flex-wrap: wrap; }

    .focus-tag {
      background: rgba(255,255,255,0.25);
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .focus-tag .remove-focus {
      cursor: pointer;
      font-weight: bold;
      opacity: 0.8;
    }

    .focus-tag .remove-focus:hover { opacity: 1; }

    /* Navigation */
    .nav-tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #ddd;
      overflow-x: auto;
    }

    .nav-tab {
      padding: 14px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.95rem;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-tab:hover { color: #667eea; background: #f8f9ff; }
    .nav-tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }

    /* Main Content */
    .main-content {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Buttons */
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-secondary:hover { background: #d0d0d0; }

    .btn-danger { background: #e74c3c; color: white; }
    .btn-danger:hover { background: #c0392b; }

    .btn-success { background: #27ae60; color: white; }
    .btn-success:hover { background: #219a52; }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-xs { padding: 4px 8px; font-size: 0.75rem; }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .card-title { font-size: 1.1rem; font-weight: 600; color: #333; }

    /* Filters */
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 15px;
    }

    .filter-group { min-width: 150px; }

    .filter-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #555;
      font-size: 0.85rem;
    }

    .filter-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      background: white;
    }

    /* Tree View */
    .tree-container {
      max-height: 70vh;
      overflow-y: auto;
      padding: 10px 0;
    }

    .tree-node {
      margin-left: 0;
      padding: 8px 0;
    }

    .tree-node-content {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 15px;
      background: #fafafa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      transition: all 0.2s;
    }

    .tree-node-content:hover {
      background: #f0f4ff;
      transform: translateX(3px);
    }

    .tree-node-content.focused {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-left-color: #f5576c;
    }

    .tree-node-content.done {
      opacity: 0.6;
      border-left-color: #27ae60;
    }

    .tree-node-content.blocked {
      border-left-color: #e74c3c;
    }

    .tree-toggle {
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .tree-toggle.empty {
      background: transparent;
      color: transparent;
    }

    .tree-node-info { flex: 1; min-width: 0; }

    .tree-node-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tree-node-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .tree-children {
      margin-left: 30px;
      border-left: 2px dashed #ddd;
      padding-left: 15px;
    }

    .tree-children.collapsed { display: none; }

    /* Tags */
    .tag {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .tag.inherited {
      opacity: 0.6;
      font-style: italic;
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .status-not_started { background: #eceff1; color: #546e7a; }
    .status-in_progress { background: #fff8e1; color: #f9a825; }
    .status-done { background: #e8f5e9; color: #2e7d32; }
    .status-blocked { background: #ffebee; color: #c62828; }

    .tree-node-actions {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }

    /* Quick Chat */
    .chat-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .chat-messages {
      min-height: 300px;
      max-height: 50vh;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .chat-message {
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 15px;
      max-width: 85%;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.bot {
      background: white;
      color: #333;
      align-self: flex-start;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chat-message.user {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-left: auto;
    }

    .chat-input-area {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 0.95rem;
      outline: none;
    }

    .chat-input:focus { border-color: #667eea; }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }

    .quick-action {
      padding: 8px 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .quick-action:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 550px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 { font-size: 1.2rem; }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
    }

    .modal-close:hover { color: #333; }

    .modal-body { padding: 20px; }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Form */
    .form-group { margin-bottom: 18px; }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea { resize: vertical; min-height: 70px; }

    /* Tag Selector */
    .tag-selector {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .tag-type-group { margin-bottom: 12px; }

    .tag-type-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #888;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .tag-options { display: flex; flex-wrap: wrap; gap: 6px; }

    .tag-option {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .tag-option:hover { transform: scale(1.05); }
    .tag-option.selected { border-color: #333; }

    /* Tags Table */
    .tags-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .tag-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tag-color {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .tag-info { flex: 1; }
    .tag-name { font-weight: 600; color: #333; }
    .tag-type-label { font-size: 0.8rem; color: #888; }

    .tag-actions { display: flex; gap: 5px; }

    /* Task Results */
    .task-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .task-result-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border-left: 4px solid #667eea;
    }

    .task-result-card h4 { margin-bottom: 8px; color: #333; }

    .task-result-card .path {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 8px;
    }

    /* Loading & Empty */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: #888;
    }

    .empty-state-icon { font-size: 3.5rem; margin-bottom: 15px; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #333;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 12px 15px; }
      .header h1 { font-size: 1.2rem; }
      .main-content { padding: 15px; }
      .tree-children { margin-left: 20px; padding-left: 10px; }
      .tree-node-actions { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>üéØ Task Finder</h1>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
    <button class="btn btn-secondary" onclick="openTagModal()">+ New Tag</button>
  </div>
</div>

<!-- Focus Banner -->
<div class="focus-banner" id="focusBanner">
  <span>üéØ <strong>Focus:</strong></span>
  <div class="focus-tags" id="focusTags"></div>
  <button class="btn btn-sm" style="background: rgba(255,255,255,0.25); color: white;" onclick="clearAllFocus()">Clear All</button>
</div>

<!-- Navigation -->
<div class="nav-tabs">
  <button class="nav-tab active" onclick="switchTab('tasks')">üìã Tasks</button>
  <button class="nav-tab" onclick="switchTab('tags')">üè∑Ô∏è Tags</button>
  <button class="nav-tab" onclick="switchTab('chat')">üí¨ Quick Chat</button>
  <button class="nav-tab" onclick="switchTab('find')">üîç Find Task</button>
</div>

<!-- Main Content -->
<div class="main-content">

  <!-- Tasks Tab -->
  <div id="tasks-tab" class="tab-content active">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üìã Task Tree</span>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-sm btn-secondary" onclick="expandAllNodes()">Expand All</button>
          <button class="btn btn-sm btn-secondary" onclick="collapseAllNodes()">Collapse All</button>
        </div>
      </div>
      
      <div class="filter-section" id="filterSection"></div>
      
      <div class="tree-container" id="treeContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading tasks...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tags Tab -->
  <div id="tags-tab" class="tab-content">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üè∑Ô∏è Manage Tags</span>
        <button class="btn btn-primary btn-sm" onclick="openTagModal()">+ New Tag</button>
      </div>
      <div id="tagsContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading tags...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Chat Tab -->
  <div id="chat-tab" class="tab-content">
    <div class="chat-container">
      <div class="card">
        <div class="card-title" style="margin-bottom: 15px;">üí¨ Quick Chat - Set Focus</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="Type a command... (e.g., 'focus on AI')" onkeypress="if(event.key==='Enter')sendChatMessage()">
          <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
        </div>
        <div class="quick-actions" id="quickActions"></div>
      </div>
    </div>
  </div>

  <!-- Find Task Tab -->
  <div id="find-tab" class="tab-content">
    <div class="chat-container">
      <div class="card">
        <div class="card-title" style="margin-bottom: 15px;">üîç Find a Task</div>
        <div id="findContainer"></div>
      </div>
    </div>
  </div>

</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="taskModalTitle">New Task</h2>
      <button class="modal-close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="taskId">
      
      <div class="form-group">
        <label>Task Name *</label>
        <input type="text" id="taskName" placeholder="Enter task name">
      </div>
      
      <div class="form-group">
        <label>Parent Task</label>
        <select id="taskParent">
          <option value="">None (Root Task)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Status</label>
        <select id="taskStatus">
          <option value="not_started">Not Started</option>
          <option value="in_progress">In Progress</option>
          <option value="done">Done</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <textarea id="taskNotes" placeholder="Additional notes..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Link</label>
        <input type="text" id="taskLinks" placeholder="https://... or file path">
      </div>
      
      <div class="form-group">
        <label>Tags (own tags, not inherited)</label>
        <div class="tag-selector" id="taskTagSelector"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- Tag Modal -->
<div class="modal-overlay" id="tagModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 id="tagModalTitle">New Tag</h2>
      <button class="modal-close" onclick="closeTagModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="tagId">
      
      <div class="form-group">
        <label>Tag Name *</label>
        <input type="text" id="tagName" placeholder="Enter tag name">
      </div>
      
      <div class="form-group">
        <label>Type *</label>
        <select id="tagType">
          <option value="subject">Subject</option>
          <option value="category">Category</option>
          <option value="mood">Mood</option>
          <option value="location">Location</option>
          <option value="duration">Duration</option>
          <option value="priority">Priority</option>
          <option value="project">Project</option>
          <option value="tool">Tool</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Color</label>
        <input type="color" id="tagColor" value="#667eea" style="width: 100%; height: 45px; cursor: pointer;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeTagModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveTag()">Save Tag</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p id="deleteMessage">Are you sure?</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
// ==================================================
// SUPABASE CONFIG
// ==================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ==================================================
// GLOBAL STATE
// ==================================================
let allTasks = [];
let allTags = [];
let taskTagsMap = {};  // task_id -> [tag_ids]
let selectedTagIds = new Set();
let collapsedNodes = new Set();
let currentFilters = {};
let deleteCallback = null;

const MOOD_HIERARCHY = ['Energetic', 'Bit tired', 'Tired', 'Sleepy'];

// ==================================================
// INITIALIZATION
// ==================================================
async function init() {
  await Promise.all([loadTags(), loadTasks(), loadTaskTags()]);
  renderFilters();
  renderTree();
  renderTagsGrid();
  initChat();
  initFindTask();
  updateFocusBanner();
}

// ==================================================
// DATA LOADING
// ==================================================
async function loadTags() {
  const { data, error } = await db.from('tags').select('*').order('type').order('name');
  if (error) { console.error(error); showToast('Error loading tags', 'error'); return; }
  allTags = data || [];
}

async function loadTasks() {
  const { data, error } = await db.from('tasks').select('*').order('created_at');
  if (error) { console.error(error); showToast('Error loading tasks', 'error'); return; }
  allTasks = data || [];
}

async function loadTaskTags() {
  const { data, error } = await db.from('task_tags').select('*');
  if (error) { console.error(error); return; }
  taskTagsMap = {};
  (data || []).forEach(tt => {
    if (!taskTagsMap[tt.task_id]) taskTagsMap[tt.task_id] = [];
    taskTagsMap[tt.task_id].push(tt.tag_id);
  });
}

// ==================================================
// TAG INHERITANCE
// ==================================================
function getAncestorIds(taskId) {
  const ancestors = [];
  let current = allTasks.find(t => t.id === taskId);
  while (current && current.parent_id) {
    ancestors.push(current.parent_id);
    current = allTasks.find(t => t.id === current.parent_id);
  }
  return ancestors;
}

function getInheritedTags(taskId) {
  const ownTagIds = taskTagsMap[taskId] || [];
  const ancestorIds = getAncestorIds(taskId);
  
  const inheritedTagIds = new Set();
  ancestorIds.forEach(aid => {
    (taskTagsMap[aid] || []).forEach(tid => inheritedTagIds.add(tid));
  });
  
  const ownTags = allTags.filter(t => ownTagIds.includes(t.id)).map(t => ({ ...t, inherited: false }));
  const inherited = allTags.filter(t => inheritedTagIds.has(t.id) && !ownTagIds.includes(t.id)).map(t => ({ ...t, inherited: true }));
  
  return [...ownTags, ...inherited];
}

function getAllTagsForTask(taskId) {
  return getInheritedTags(taskId);
}

// ==================================================
// TREE BUILDING
// ==================================================
function buildTree() {
  const taskMap = {};
  allTasks.forEach(t => { taskMap[t.id] = { ...t, children: [] }; });
  
  const roots = [];
  allTasks.forEach(t => {
    if (t.parent_id && taskMap[t.parent_id]) {
      taskMap[t.parent_id].children.push(taskMap[t.id]);
    } else if (!t.parent_id) {
      roots.push(taskMap[t.id]);
    }
  });
  
  return roots;
}

function filterTree(nodes, focusedTagIds) {
  if (focusedTagIds.length === 0) return nodes;
  
  function hasMatchingDescendant(node) {
    const nodeTags = getAllTagsForTask(node.id).map(t => t.id);
    if (focusedTagIds.some(fid => nodeTags.includes(fid))) return true;
    return node.children.some(c => hasMatchingDescendant(c));
  }
  
  function filterNode(node) {
    const nodeTags = getAllTagsForTask(node.id).map(t => t.id);
    const matches = focusedTagIds.some(fid => nodeTags.includes(fid));
    const filteredChildren = node.children.map(c => filterNode(c)).filter(c => c !== null);
    
    if (matches || filteredChildren.length > 0) {
      return { ...node, children: filteredChildren, isMatch: matches };
    }
    return null;
  }
  
  return nodes.map(n => filterNode(n)).filter(n => n !== null);
}

// ==================================================
// RENDERING
// ==================================================
function renderFilters() {
  const container = document.getElementById('filterSection');
  const types = [...new Set(allTags.map(t => t.type))].sort();
  
  container.innerHTML = types.map(type => `
    <div class="filter-group">
      <label>${capitalize(type)}</label>
      <select onchange="applyFilter('${type}', this.value)">
        <option value="">All</option>
        ${allTags.filter(t => t.type === type).map(t => 
          `<option value="${t.id}">${t.name}</option>`
        ).join('')}
      </select>
    </div>
  `).join('');
}

function applyFilter(type, tagId) {
  if (tagId) {
    currentFilters[type] = tagId;
  } else {
    delete currentFilters[type];
  }
  renderTree();
}

function renderTree() {
  const container = document.getElementById('treeContainer');
  let tree = buildTree();
  
  // Apply focus filter
  const focusedTagIds = allTags.filter(t => t.is_focused).map(t => t.id);
  if (focusedTagIds.length > 0) {
    tree = filterTree(tree, focusedTagIds);
  }
  
  // Apply dropdown filters
  const filterTagIds = Object.values(currentFilters);
  if (filterTagIds.length > 0) {
    tree = filterTree(tree, filterTagIds);
  }
  
  if (tree.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No tasks found</h3>
        <p>Try adjusting filters or add a new task</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = tree.map(node => renderTreeNode(node, 0)).join('');
}

function renderTreeNode(node, depth) {
  const hasChildren = node.children && node.children.length > 0;
  const isCollapsed = collapsedNodes.has(node.id);
  const tags = getAllTagsForTask(node.id);
  const statusClass = `status-${node.status || 'not_started'}`;
  const focusedTagIds = allTags.filter(t => t.is_focused).map(t => t.id);
  const isFocused = tags.some(t => focusedTagIds.includes(t.id));
  
  const nodeClasses = [
    'tree-node-content',
    node.status === 'done' ? 'done' : '',
    node.status === 'blocked' ? 'blocked' : '',
    isFocused ? 'focused' : ''
  ].filter(Boolean).join(' ');
  
  return `
    <div class="tree-node">
      <div class="${nodeClasses}">
        <div class="tree-toggle ${hasChildren ? '' : 'empty'}" onclick="toggleNode('${node.id}')">
          ${hasChildren ? (isCollapsed ? '+' : '‚àí') : ''}
        </div>
        <div class="tree-node-info">
          <div class="tree-node-name">
            ${escapeHtml(node.name)}
            <span class="status-badge ${statusClass}">${capitalize((node.status || 'not_started').replace('_', ' '))}</span>
          </div>
          ${node.links ? `<a href="${node.links}" target="_blank" style="font-size: 0.8rem; color: #667eea;">üîó Link</a>` : ''}
          <div class="tree-node-tags">
            ${tags.map(t => `
              <span class="tag ${t.inherited ? 'inherited' : ''}" style="background: ${t.color}20; color: ${t.color}">
                ${t.name}${t.inherited ? ' ‚Üë' : ''}
              </span>
            `).join('')}
          </div>
        </div>
        <div class="tree-node-actions">
          <button class="btn btn-xs btn-secondary" onclick="openTaskModal('${node.id}')">‚úèÔ∏è</button>
          <button class="btn btn-xs btn-success" onclick="addChildTask('${node.id}')">+</button>
          <button class="btn btn-xs btn-danger" onclick="deleteTask('${node.id}')">üóëÔ∏è</button>
        </div>
      </div>
      ${hasChildren ? `
        <div class="tree-children ${isCollapsed ? 'collapsed' : ''}">
          ${node.children.map(c => renderTreeNode(c, depth + 1)).join('')}
        </div>
      ` : ''}
    </div>
  `;
}

function toggleNode(id) {
  if (collapsedNodes.has(id)) {
    collapsedNodes.delete(id);
  } else {
    collapsedNodes.add(id);
  }
  renderTree();
}

function expandAllNodes() {
  collapsedNodes.clear();
  renderTree();
}

function collapseAllNodes() {
  allTasks.forEach(t => {
    if (allTasks.some(c => c.parent_id === t.id)) {
      collapsedNodes.add(t.id);
    }
  });
  renderTree();
}

function renderTagsGrid() {
  const container = document.getElementById('tagsContainer');
  const types = [...new Set(allTags.map(t => t.type))].sort();
  
  if (allTags.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><h3>No tags yet</h3></div>`;
    return;
  }
  
  container.innerHTML = types.map(type => `
    <h4 style="margin: 20px 0 10px; color: #666; text-transform: uppercase; font-size: 0.85rem;">${type}</h4>
    <div class="tags-grid">
      ${allTags.filter(t => t.type === type).map(tag => `
        <div class="tag-card">
          <div class="tag-color" style="background: ${tag.color}"></div>
          <div class="tag-info">
            <div class="tag-name">${escapeHtml(tag.name)}</div>
            <div class="tag-type-label">${tag.is_focused ? '‚≠ê Focused' : ''}</div>
          </div>
          <div class="tag-actions">
            <button class="btn btn-xs ${tag.is_focused ? 'btn-success' : 'btn-secondary'}" onclick="toggleFocus('${tag.id}')">${tag.is_focused ? '‚≠ê' : '‚òÜ'}</button>
            <button class="btn btn-xs btn-secondary" onclick="editTag('${tag.id}')">‚úèÔ∏è</button>
            <button class="btn btn-xs btn-danger" onclick="deleteTag('${tag.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function renderTaskTagSelector() {
  const container = document.getElementById('taskTagSelector');
  const types = [...new Set(allTags.map(t => t.type))].sort();
  
  container.innerHTML = types.map(type => `
    <div class="tag-type-group">
      <div class="tag-type-title">${type}</div>
      <div class="tag-options">
        ${allTags.filter(t => t.type === type).map(t => `
          <span class="tag-option ${selectedTagIds.has(t.id) ? 'selected' : ''}"
                style="background: ${t.color}20; color: ${t.color}"
                onclick="toggleTaskTag('${t.id}')">
            ${t.name}
          </span>
        `).join('')}
      </div>
    </div>
  `).join('');
}

function renderParentSelect(excludeId = null) {
  const select = document.getElementById('taskParent');
  select.innerHTML = '<option value="">None (Root Task)</option>';
  
  function addOptions(tasks, depth = 0) {
    tasks.forEach(t => {
      if (t.id !== excludeId) {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = '  '.repeat(depth) + t.name;
        select.appendChild(option);
      }
      const children = allTasks.filter(c => c.parent_id === t.id);
      if (children.length > 0) addOptions(children, depth + 1);
    });
  }
  
  const roots = allTasks.filter(t => !t.parent_id);
  addOptions(roots);
}

// ==================================================
// FOCUS SYSTEM
// ==================================================
async function toggleFocus(tagId) {
  const tag = allTags.find(t => t.id === tagId);
  if (!tag) return;
  
  const { error } = await db.from('tags').update({ is_focused: !tag.is_focused }).eq('id', tagId);
  if (error) { showToast('Error updating focus', 'error'); return; }
  
  await loadTags();
  renderTagsGrid();
  renderTree();
  updateFocusBanner();
  updateQuickActions();
  showToast(tag.is_focused ? `Removed focus from ${tag.name}` : `Focused on ${tag.name}`, 'success');
}

async function clearAllFocus() {
  const { error } = await db.from('tags').update({ is_focused: false }).eq('is_focused', true);
  if (error) { showToast('Error clearing focus', 'error'); return; }
  
  await loadTags();
  renderTagsGrid();
  renderTree();
  updateFocusBanner();
  updateQuickActions();
  showToast('Focus cleared', 'success');
}

function updateFocusBanner() {
  const focused = allTags.filter(t => t.is_focused);
  const banner = document.getElementById('focusBanner');
  const tagsContainer = document.getElementById('focusTags');
  
  if (focused.length === 0) {
    banner.classList.remove('active');
    return;
  }
  
  banner.classList.add('active');
  tagsContainer.innerHTML = focused.map(t => `
    <span class="focus-tag" style="background: ${t.color}40;">
      ${t.name}
      <span class="remove-focus" onclick="toggleFocus('${t.id}')">&times;</span>
    </span>
  `).join('');
}

// ==================================================
// TASK CRUD
// ==================================================
function openTaskModal(taskId = null) {
  document.getElementById('taskModal').classList.add('active');
  document.getElementById('taskModalTitle').textContent = taskId ? 'Edit Task' : 'New Task';
  
  document.getElementById('taskId').value = '';
  document.getElementById('taskName').value = '';
  document.getElementById('taskParent').value = '';
  document.getElementById('taskStatus').value = 'not_started';
  document.getElementById('taskNotes').value = '';
  document.getElementById('taskLinks').value = '';
  selectedTagIds.clear();
  
  renderParentSelect(taskId);
  
  if (taskId) {
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
      document.getElementById('taskId').value = task.id;
      document.getElementById('taskName').value = task.name;
      document.getElementById('taskParent').value = task.parent_id || '';
      document.getElementById('taskStatus').value = task.status || 'not_started';
      document.getElementById('taskNotes').value = task.notes || '';
      document.getElementById('taskLinks').value = task.links || '';
      selectedTagIds = new Set(taskTagsMap[task.id] || []);
    }
  }
  
  renderTaskTagSelector();
}

function closeTaskModal() {
  document.getElementById('taskModal').classList.remove('active');
}

function addChildTask(parentId) {
  openTaskModal();
  document.getElementById('taskParent').value = parentId;
}

function toggleTaskTag(tagId) {
  if (selectedTagIds.has(tagId)) {
    selectedTagIds.delete(tagId);
  } else {
    selectedTagIds.add(tagId);
  }
  renderTaskTagSelector();
}

async function saveTask() {
  const taskId = document.getElementById('taskId').value;
  const name = document.getElementById('taskName').value.trim();
  const parent_id = document.getElementById('taskParent').value || null;
  const status = document.getElementById('taskStatus').value;
  const notes = document.getElementById('taskNotes').value.trim();
  const links = document.getElementById('taskLinks').value.trim();
  
  if (!name) { showToast('Task name is required', 'error'); return; }
  
  try {
    let savedId = taskId;
    
    if (taskId) {
      const { error } = await db.from('tasks').update({ name, parent_id, status, notes, links }).eq('id', taskId);
      if (error) throw error;
      await db.from('task_tags').delete().eq('task_id', taskId);
    } else {
      const { data, error } = await db.from('tasks').insert({ name, parent_id, status, notes, links }).select().single();
      if (error) throw error;
      savedId = data.id;
    }
    
    if (selectedTagIds.size > 0) {
      const tagLinks = Array.from(selectedTagIds).map(tid => ({ task_id: savedId, tag_id: tid }));
      const { error } = await db.from('task_tags').insert(tagLinks);
      if (error) throw error;
    }
    
    closeTaskModal();
    showToast(taskId ? 'Task updated!' : 'Task created!', 'success');
    await loadTasks();
    await loadTaskTags();
    renderTree();
  } catch (err) {
    console.error(err);
    showToast('Error saving task', 'error');
  }
}

function deleteTask(taskId) {
  const task = allTasks.find(t => t.id === taskId);
  const childCount = allTasks.filter(t => t.parent_id === taskId).length;
  
  document.getElementById('deleteMessage').textContent = childCount > 0
    ? `Delete "${task?.name}"? This will also delete ${childCount} child task(s).`
    : `Delete "${task?.name}"?`;
  document.getElementById('deleteModal').classList.add('active');
  
  deleteCallback = async () => {
    const { error } = await db.from('tasks').delete().eq('id', taskId);
    if (error) { showToast('Error deleting task', 'error'); return; }
    showToast('Task deleted!', 'success');
    await loadTasks();
    await loadTaskTags();
    renderTree();
  };
}

// ==================================================
// TAG CRUD
// ==================================================
function openTagModal(tagId = null) {
  document.getElementById('tagModal').classList.add('active');
  document.getElementById('tagModalTitle').textContent = tagId ? 'Edit Tag' : 'New Tag';
  
  document.getElementById('tagId').value = '';
  document.getElementById('tagName').value = '';
  document.getElementById('tagType').value = 'category';
  document.getElementById('tagColor').value = '#667eea';
  
  if (tagId) {
    const tag = allTags.find(t => t.id === tagId);
    if (tag) {
      document.getElementById('tagId').value = tag.id;
      document.getElementById('tagName').value = tag.name;
      document.getElementById('tagType').value = tag.type;
      document.getElementById('tagColor').value = tag.color;
    }
  }
}

function closeTagModal() {
  document.getElementById('tagModal').classList.remove('active');
}

function editTag(tagId) {
  openTagModal(tagId);
}

async function saveTag() {
  const tagId = document.getElementById('tagId').value;
  const name = document.getElementById('tagName').value.trim();
  const type = document.getElementById('tagType').value;
  const color = document.getElementById('tagColor').value;
  
  if (!name) { showToast('Tag name is required', 'error'); return; }
  
  try {
    if (tagId) {
      const { error } = await db.from('tags').update({ name, type, color }).eq('id', tagId);
      if (error) throw error;
    } else {
      const { error } = await db.from('tags').insert({ name, type, color });
      if (error) throw error;
    }
    
    closeTagModal();
    showToast(tagId ? 'Tag updated!' : 'Tag created!', 'success');
    await loadTags();
    renderFilters();
    renderTagsGrid();
    renderTaskTagSelector();
    updateQuickActions();
  } catch (err) {
    console.error(err);
    showToast('Error saving tag', 'error');
  }
}

function deleteTag(tagId) {
  const tag = allTags.find(t => t.id === tagId);
  document.getElementById('deleteMessage').textContent = `Delete tag "${tag?.name}"? It will be removed from all tasks.`;
  document.getElementById('deleteModal').classList.add('active');
  
  deleteCallback = async () => {
    const { error } = await db.from('tags').delete().eq('id', tagId);
    if (error) { showToast('Error deleting tag', 'error'); return; }
    showToast('Tag deleted!', 'success');
    await loadTags();
    await loadTaskTags();
    renderFilters();
    renderTagsGrid();
    renderTree();
    updateQuickActions();
  };
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
  deleteCallback = null;
}

function confirmDelete() {
  if (deleteCallback) deleteCallback();
  closeDeleteModal();
}

// ==================================================
// QUICK CHAT
// ==================================================
function initChat() {
  const container = document.getElementById('chatMessages');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  
  addChatMessage("üëã Hi! I can help you set focus. Try commands like:", true);
  addChatMessage("‚Ä¢ \"focus on AI\"\n‚Ä¢ \"add Japanese to focus\"\n‚Ä¢ \"clear focus\"\n‚Ä¢ \"what's my focus?\"", true);
  
  updateQuickActions();
}

function updateQuickActions() {
  const container = document.getElementById('quickActions');
  const subjects = allTags.filter(t => t.type === 'subject');
  
  container.innerHTML = `
    <span class="quick-action" onclick="processChatCommand('clear focus')">Clear Focus</span>
    ${subjects.slice(0, 5).map(t => `
      <span class="quick-action" onclick="processChatCommand('focus on ${t.name}')">${t.is_focused ? '‚≠ê' : ''} ${t.name}</span>
    `).join('')}
  `;
}

function addChatMessage(text, isBot) {
  const container = document.getElementById('chatMessages');
  const msg = document.createElement('div');
  msg.className = `chat-message ${isBot ? 'bot' : 'user'}`;
  msg.innerHTML = text.replace(/\n/g, '<br>');
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  
  addChatMessage(text, false);
  input.value = '';
  
  processChatCommand(text);
}

async function processChatCommand(text) {
  const lower = text.toLowerCase();
  
  // Clear focus
  if (lower.includes('clear') && lower.includes('focus')) {
    await clearAllFocus();
    addChatMessage("‚úÖ Focus cleared! Showing all tasks now.", true);
    return;
  }
  
  // What's my focus?
  if (lower.includes('what') && lower.includes('focus')) {
    const focused = allTags.filter(t => t.is_focused);
    if (focused.length === 0) {
      addChatMessage("You don't have any focus set. Try \"focus on AI\" or \"focus on Japanese\".", true);
    } else {
      addChatMessage(`Your current focus: ${focused.map(t => t.name).join(', ')}`, true);
    }
    return;
  }
  
  // Focus on X / Add X to focus
  const focusMatch = lower.match(/(?:focus on|add|set focus to)\s+(.+)/);
  if (focusMatch) {
    const tagName = focusMatch[1].trim();
    const tag = allTags.find(t => t.name.toLowerCase() === tagName);
    
    if (tag) {
      if (!tag.is_focused) {
        await db.from('tags').update({ is_focused: true }).eq('id', tag.id);
        await loadTags();
        renderTagsGrid();
        renderTree();
        updateFocusBanner();
        updateQuickActions();
      }
      const taskCount = allTasks.filter(t => getAllTagsForTask(t.id).some(tg => tg.id === tag.id)).length;
      addChatMessage(`‚úÖ Focused on "${tag.name}". Found ${taskCount} related task(s).`, true);
    } else {
      addChatMessage(`‚ùì I couldn't find a tag called "${tagName}". Available tags: ${allTags.filter(t => t.type === 'subject').map(t => t.name).join(', ')}`, true);
    }
    return;
  }
  
  // Remove X from focus
  const removeMatch = lower.match(/(?:remove|unfocus)\s+(.+)/);
  if (removeMatch) {
    const tagName = removeMatch[1].replace(/from focus/i, '').trim();
    const tag = allTags.find(t => t.name.toLowerCase() === tagName);
    
    if (tag && tag.is_focused) {
      await db.from('tags').update({ is_focused: false }).eq('id', tag.id);
      await loadTags();
      renderTagsGrid();
      renderTree();
      updateFocusBanner();
      updateQuickActions();
      addChatMessage(`‚úÖ Removed "${tag.name}" from focus.`, true);
    } else {
      addChatMessage(`"${tagName}" is not in your focus.`, true);
    }
    return;
  }
  
  // Default response
  addChatMessage("ü§î I didn't understand. Try:\n‚Ä¢ \"focus on AI\"\n‚Ä¢ \"clear focus\"\n‚Ä¢ \"what's my focus?\"", true);
}

// ==================================================
// FIND TASK (Decision Tree)
// ==================================================
let findStep = 0;
let findSelections = {};

function initFindTask() {
  const container = document.getElementById('findContainer');
  container.innerHTML = `
    <div id="findMessages" style="min-height: 200px;"></div>
    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="startFindTask()">üîç Find a Task</button>
  `;
}

function startFindTask() {
  findStep = 0;
  findSelections = {};
  document.getElementById('findMessages').innerHTML = '';
  addFindMessage("Let's find you a task! üéØ", true);
  setTimeout(askFindQuestion, 500);
}

function addFindMessage(text, isBot) {
  const container = document.getElementById('findMessages');
  const msg = document.createElement('div');
  msg.className = `chat-message ${isBot ? 'bot' : 'user'}`;
  msg.innerHTML = text;
  container.appendChild(msg);
  container.scrollTop = container.scrollHeight;
}

function addFindOptions(options, callback) {
  const container = document.getElementById('findMessages');
  const div = document.createElement('div');
  div.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0;';
  
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-secondary';
    btn.textContent = opt.label;
    btn.onclick = () => {
      addFindMessage(opt.label, false);
      div.remove();
      callback(opt.value);
    };
    div.appendChild(btn);
  });
  
  container.appendChild(div);
}

function askFindQuestion() {
  const questions = [
    {
      q: "How are you feeling?",
      type: 'mood',
      getOptions: () => {
        const moods = allTags.filter(t => t.type === 'mood');
        return [...moods.map(t => ({ label: t.name, value: t.id })), { label: 'Any mood', value: null }];
      }
    },
    {
      q: "Where are you?",
      type: 'location',
      getOptions: () => {
        const locs = allTags.filter(t => t.type === 'location');
        return [...locs.map(t => ({ label: t.name, value: t.id })), { label: 'Anywhere', value: null }];
      }
    },
    {
      q: "What subject?",
      type: 'subject',
      getOptions: () => {
        const subs = allTags.filter(t => t.type === 'subject');
        return [...subs.map(t => ({ label: t.name, value: t.id })), { label: 'Any subject', value: null }];
      }
    }
  ];
  
  if (findStep >= questions.length) {
    showFindResults();
    return;
  }
  
  const q = questions[findStep];
  addFindMessage(q.q, true);
  
  setTimeout(() => {
    addFindOptions(q.getOptions(), (value) => {
      findSelections[q.type] = value;
      findStep++;
      setTimeout(askFindQuestion, 300);
    });
  }, 300);
}

function showFindResults() {
  let filtered = allTasks.filter(t => {
    // Only leaf tasks (no children)
    const hasChildren = allTasks.some(c => c.parent_id === t.id);
    return !hasChildren;
  });
  
  // Filter by selections
  Object.entries(findSelections).forEach(([type, tagId]) => {
    if (tagId) {
      filtered = filtered.filter(t => {
        const tags = getAllTagsForTask(t.id);
        
        // Special mood handling (hierarchical)
        if (type === 'mood') {
          const filterTag = allTags.find(tg => tg.id === tagId);
          const filterIdx = MOOD_HIERARCHY.indexOf(filterTag?.name);
          const taskMoodTags = tags.filter(tg => tg.type === 'mood');
          if (taskMoodTags.length === 0) return true;
          return taskMoodTags.some(mt => {
            const taskIdx = MOOD_HIERARCHY.indexOf(mt.name);
            return taskIdx !== -1 && taskIdx <= filterIdx;
          });
        }
        
        return tags.some(tg => tg.id === tagId);
      });
    }
  });
  
  if (filtered.length === 0) {
    addFindMessage("üòï No tasks match your criteria. Try different options!", true);
  } else {
    addFindMessage(`Found ${filtered.length} task(s):`, true);
    
    const container = document.getElementById('findMessages');
    filtered.slice(0, 5).forEach(task => {
      const path = getTaskPath(task.id);
      const tags = getAllTagsForTask(task.id);
      
      const card = document.createElement('div');
      card.className = 'task-result-card';
      card.innerHTML = `
        <h4>${escapeHtml(task.name)}</h4>
        <div class="path">${path}</div>
        <div class="tree-node-tags">
          ${tags.slice(0, 5).map(t => `<span class="tag" style="background: ${t.color}20; color: ${t.color}">${t.name}</span>`).join('')}
        </div>
        ${task.links ? `<a href="${task.links}" target="_blank" style="color: #667eea; font-size: 0.85rem; display: block; margin-top: 8px;">üîó Open Link</a>` : ''}
      `;
      container.appendChild(card);
    });
  }
  
  setTimeout(() => {
    const container = document.getElementById('findMessages');
    const btn = document.createElement('button');
    btn.className = 'btn btn-primary';
    btn.style.cssText = 'width: 100%; margin-top: 15px;';
    btn.textContent = 'üîç Search Again';
    btn.onclick = startFindTask;
    container.appendChild(btn);
  }, 500);
}

function getTaskPath(taskId) {
  const parts = [];
  let current = allTasks.find(t => t.id === taskId);
  while (current) {
    parts.unshift(current.name);
    current = allTasks.find(t => t.id === current.parent_id);
  }
  return parts.join(' ‚Üí ');
}

// ==================================================
// NAVIGATION
// ==================================================
function switchTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`${tabName}-tab`).classList.add('active');
}

// ==================================================
// UTILITIES
// ==================================================
function showToast(msg, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// ==================================================
// START
// ==================================================
init();
</script>

</body>
</html>
